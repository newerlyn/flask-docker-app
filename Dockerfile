# ============================================
# Dockerfile для Flask приложения
# ============================================

# Базовый образ: официальный Python 3.9 (легковесная версия)
FROM python:3.9-slim

# ============================================
# МЕТАДАННЫЕ
# ============================================
LABEL maintainer="student@university.edu"
LABEL version="1.0"
LABEL description="Flask приложение для лабораторной работы по Docker"

# ============================================
# ПЕРЕМЕННЫЕ ОКРУЖЕНИЯ
# ============================================

# Предотвращаем буферизацию вывода Python
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# Порт по умолчанию (можно переопределить при запуске)
ENV PORT=8000

# Имя приложения
ENV APP_NAME="Flask Docker App"

# Режим отладки
ENV DEBUG="False"

# Помечаем, что мы в контейнере
ENV IN_DOCKER="True"

# ============================================
# УСТАНОВКА ЗАВИСИМОСТЕЙ СИСТЕМЫ
# ============================================

# Обновляем пакеты и устанавливаем необходимые утилиты
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    vim \
    tree \
    && rm -rf /var/lib/apt/lists/*

# ============================================
# НАСТРОЙКА РАБОЧЕЙ ДИРЕКТОРИИ
# ============================================

# Создаем пользователя для безопасности (не запускаем от root)
RUN useradd -m -u 1000 appuser

# Создаем рабочую директорию
WORKDIR /app

# Меняем владельца на appuser
RUN chown -R appuser:appuser /app

# Переключаемся на непривилегированного пользователя
USER appuser

# ============================================
# УСТАНОВКА PYTHON ЗАВИСИМОСТЕЙ
# ============================================

# Копируем файл с зависимостями
COPY --chown=appuser:appuser requirements.txt .

# Устанавливаем Python зависимости
RUN pip install --no-cache-dir --user -r requirements.txt

# Добавляем pip packages в PATH
ENV PATH="/home/appuser/.local/bin:${PATH}"

# ============================================
# КОПИРОВАНИЕ ИСХОДНОГО КОДА
# ============================================

# Копируем весь проект (кроме того, что в .dockerignore)
COPY --chown=appuser:appuser . .

# ============================================
# СОЗДАНИЕ ДИРЕКТОРИЙ
# ============================================

# Создаем директорию для хранения файлов
RUN mkdir -p storage

# ============================================
# VOLUME ДЛЯ СОХРАНЕНИЯ ДАННЫХ
# ============================================

# Объявляем volume для хранения файлов
# Это позволяет сохранять данные между перезапусками контейнера
VOLUME ["/app/storage"]

# ============================================
# ОТКРЫТИЕ ПОРТА
# ============================================

# Открываем порт для доступа извне
# Используем переменную окружения PORT
EXPOSE ${PORT}

# ============================================
# КОМАНДА ЗАПУСКА
# ============================================

# Запускаем приложение
CMD ["python", "app.py"]

# ============================================
# ДОПОЛНИТЕЛЬНЫЕ КОМАНДЫ ДЛЯ ТЕСТИРОВАНИЯ
# ============================================

# HEALTHCHECK - автоматическая проверка здоровья контейнера
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:${PORT}/health || exit 1
